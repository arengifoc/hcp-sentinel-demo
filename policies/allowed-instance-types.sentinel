import "tfplan/v2" as tfplan

allowed = ["t3.micro", "t3.small"]

# Filter AWS instances being created or updated
instances = filter tfplan.resource_changes as _, r {
  r.type == "aws_instance" and 
  r.mode == "managed" and
  (r.change.actions[0] == "create" or 
   r.change.actions[0] == "update" or
   "create" in r.change.actions or
   "update" in r.change.actions)
}

main = rule {
  all instances as _, inst {
    inst.change.after.instance_type in allowed
  }
}
